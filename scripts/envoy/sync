#!/usr/bin/env bash
set -euo pipefail

source "${DOTFILES}/scripts/envoy/aux/core.sh"

##? Envoy sync
##?
##? Usage:
##?    sync pull
##?    sync push

doc::maybe_help "$@"

LOCAL_BASE="$LOCAL_ENVOY_DIR"
REMOTE_BASE="${USER}@${IP}:~/${REMOTE_ENVOY_DIRNAME}"

_rsync() {
   log::info rsync "$@"
   echo rsync "$@"
}

_rsync_all() {
   local -r from="$1"
   local -r to="$2"

   for f in "source" "generated_api_shadow" "api"; do
      _rsync -a "${from}/${f}/" "${to}/${f}"
   done
}

_pull() {
   platform::validate_local

   log::info "Getting info..."
   local -r branch="$(git::current_branch)"

   log::info "Syncing..."
   _rsync_all "$REMOTE_BASE" "$LOCAL_BASE"
}

_push() {
   platform::validate_local

   log::info "Syncing..."
   _rsync_all "$LOCAL_BASE" "$REMOTE_BASE"
}

main() {
   local -r fn="$1"
   shift || true
   "_${fn}" "$@"
}

main "$@"
