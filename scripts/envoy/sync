#!/usr/bin/env bash
set -euo pipefail

source "${DOTFILES}/scripts/envoy/aux/core.sh"

##? Envoy sync
##?
##? Usage:
##?    sync pull
##?    sync push
##?    sync mutable

doc::maybe_help "$@"

_rsync() {
   rsync -a --exclude='.git/' "$@"
}

_pull() {
   platform::validate_local

   log::info "Getting info..."
   local -r branch="$(git::current_branch)"

   log::info "Syncing..."
   _rsync "${USER}@${IP}:~/envoy_mutable/" .

   log::info "Cleaning up..."
   feedback::enter
   git add .
   git stash
   git checkout "$branch"
   git stash pop
}

_push() {
   platform::validate_local

   log::info "Syncing..."
   _rsync . "${USER}@${IP}:~/envoy_mutable/"
}


_mutable() {
    platform::validate_remote

    log::info "Setting folders..."
    rm -rf "$REMOTE_ENVOY_MUTABLE" || true
    cp -r "$REMOTE_ENVOY" "$REMOTE_ENVOY_MUTABLE"
}

main() {
    local -r fn="$1"
    shift || true
    "_${fn}" "$@"
}

main "$@"
