#!/usr/bin/env bash
# vim: filetype=sh
set -euo pipefail

source "${DOTFILES}/scripts/core/main.sh"

##? Investing helper tools
##?
##? Usage:
##?   investing stocks
##?   investing stocks2
##?
##? Examples:
##?   investing stocks

docs::eval "$@"

fetch_blob() {
  curl 'https://br.investing.com/equities/StocksFilter?noconstruct=1&smlID=602&sid=&tabletype=performance&index_id=all' -H 'Connection: keep-alive' -H 'Accept: */*' -H 'DNT: 1' -H 'X-Requested-With: XMLHttpRequest' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.79 Safari/537.36' -H 'Sec-Fetch-Site: same-origin' -H 'Sec-Fetch-Mode: cors' -H 'Referer: https://br.investing.com/equities/brazil' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9,fr-FR;q=0.8,fr;q=0.7' -H 'G_ENABLED_IDPS=google; r_p_s_n=1; geoC=BR; gtmFired=OK; UserReactions=true; billboardCounter_30=0;' --compressed
}

fetch2() {
  curl 'https://br.investing.com/search/service/searchTopBar' -H 'Connection: keep-alive' -H 'Accept: application/json, text/javascript, */*; q=0.01' -H 'Origin: https://br.investing.com' -H 'X-Requested-With: XMLHttpRequest' -H 'User-Agent: Mozilla/5.0 (Macintosh; Intel Mac OS X 10_14_6) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.79 Safari/537.36' -H 'DNT: 1' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Sec-Fetch-Site: same-origin' -H 'Sec-Fetch-Mode: cors' -H 'Referer: https://br.investing.com/equities/brazil' -H 'Accept-Encoding: gzip, deflate, br' -H 'Accept-Language: en-US,en;q=0.9,fr-FR;q=0.8,fr;q=0.7' -H 'Cookie: adBlockerNewUserDomains=1565278656; G_ENABLED_IDPS=google; r_p_s_n=1; comment_notification_207714715=1; geoC=BR; gtmFired=OK; PHPSESSID=5a62hm7bugm25fg8vrmvtuj2kg; StickySession=id.65215722433.404.br.investing.com; UserReactions=true; SideBlockUser=a%3A2%3A%7Bs%3A10%3A%22stack_size%22%3Ba%3A1%3A%7Bs%3A11%3A%22last_quotes%22%3Bi%3A8%3B%7Ds%3A6%3A%22stacks%22%3Ba%3A1%3A%7Bs%3A11%3A%22last_quotes%22%3Ba%3A8%3A%7Bi%3A0%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A7%3A%221055134%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A29%3A%22%2Fequities%2Fparana-sanepar-unit%22%3B%7Di%3A1%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A7%3A%221037051%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A23%3A%22%2Fequities%2Fsanepar-on-n2%22%3B%7Di%3A2%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A6%3A%22969126%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A45%3A%22%2Fequities%2Fcompanhia-de-saneamento-do-parana-s%22%3B%7Di%3A3%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A5%3A%2218757%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A28%3A%22%2Fequities%2Fpositivo-inf-on-nm%22%3B%7Di%3A4%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A6%3A%22986409%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A39%3A%22%2Fequities%2Fsaraiva-sa-livreiros-editores%22%3B%7Di%3A5%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A5%3A%2218717%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A29%3A%22%2Fequities%2Flojas-americ-pn-int%22%3B%7Di%3A6%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A5%3A%2218716%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A25%3A%22%2Fequities%2Flojas-americ-on%22%3B%7Di%3A7%3Ba%3A3%3A%7Bs%3A7%3A%22pair_ID%22%3Bs%3A5%3A%2218599%22%3Bs%3A10%3A%22pair_title%22%3Bs%3A0%3A%22%22%3Bs%3A9%3A%22pair_link%22%3Bs%3A18%3A%22%2Fequities%2Fambev-pn%22%3B%7D%7D%7D%7D; billboardCounter_30=2; nyxDorf=NjIzZ2Q1MHJjMWlmZSg2NjFhMGM3LmVgMTU%3D; ses_id=NXs2dzU6YmoxdWFnYDE1NzVjMGw2MDs9MzU0NmBiZXNjdzU7ZzA%2BeGRraiRmZWR4ZzRhMmIwYTQ2NDc4OjlnYDViNmQ1MWJqMTJhZWAwNWM1ZzBrNjM7bDNgNGNgMWU5YzA1MWdlPjlkZ2oxZm9kbGd1YX1iJmFwNmQ3Zzp7ZyA1OjZ3NWZiajExYWpgZjU2NWQwbDYyOzozMjQxYGZlfWMo' --data 'search_text=campus-faria-lima' --compressed
}

extract() {
  echo "Stock|Code"
  grep '/equities/' \
    | sed -E 's|.*title="([^"]+)".*/equities/([^"]+)".*|\1\|\2|g' \
    | column -ts '|'
}

if $stocks; then
  fetch_blob | extract > "${DOTFILES}/local/stocks.txt"
else $stocks2; 
  fetch2
fi