#!/usr/bin/env bash
set -euo pipefail

source "${DOTFILES}/scripts/self/aux/test.sh"

##? Run tests
##?
##? Usage:
##?    test
##?    test suite <suite>
##?    test file <file>

docs::eval_help "$@"

_all_files() {
   find "${DOTFILES}/tests/" -iname "*.sh"
}

_source_all() {
   local -r tests="$(_all_files)"

   for test in $tests; do
      source "$test"
   done
}

_source_matching() {
   local -r match="$1"
   local -r tests="$(_all_files)"

   for test in $tests; do
      local suites="$(cat "$test" | grep 'set_suite')"
      if echo "$suites" | grep -q "$match -"; then
         source "$test"
      fi
   done
}

cmd="${1:-}"

case $cmd in
   file) source "${DOTFILES}/tests/${2}.sh" ;;
   suite) _source_matching "$2" ;;
   *) _source_all ;;
esac

test::finish
